# ISUCON 14 2024-12-08ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„å±¥æ­´

## 14:52 ğŸš€ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ã®åŠ¹æœ

### å®Ÿæ–½ã—ãŸæ”¹å–„
1. `rides`ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
   - `idx_chair_updated (chair_id, updated_at DESC)`
2. `chairs`ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ 
   - `idx_access_token (access_token)`

### æ”¹å–„åŠ¹æœ
- Rows examineãŒå¤§å¹…ã«æ¸›å°‘: 33.65M â†’ 10.68M (ç´„68%æ¸›å°‘)
- å®Ÿè¡Œæ™‚é–“ã®æ”¹å–„: 273s â†’ 208s (ç´„24%æ¸›å°‘)
- ã‚¯ã‚¨ãƒªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰åŒ–:
  - `SELECT chairs`ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ : 46.57s â†’ 7.36s (ç´„84%æ”¹å–„)
  - `SELECT rides`ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ : 53.73s â†’ 6.59s (ç´„88%æ”¹å–„)

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ”¹å–„
- `/api/chair/[w/-]+` GET
  - P95: 0.228s â†’ 0.180s (ç´„21%æ”¹å–„)
  - å¹³å‡: 0.101s â†’ 0.072s (ç´„29%æ”¹å–„)
- `/api/app/[w/-]+` GET
  - P95: 0.368s â†’ 0.326s (ç´„11%æ”¹å–„)
  - å¹³å‡: 0.181s â†’ 0.145s (ç´„20%æ”¹å–„)

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ– (COMMITãŒä¾ç„¶ã¨ã—ã¦é…ã„)
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®æ¤œè¨
3. æ®‹ã‚Šã®ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªã®åˆ†æã¨æ”¹å–„


## 14:36

+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM    |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| 11287 | 0   | 11272 | 0    | 15  | 0   | GET    | /api/chair/[\w/-]+            | 0.005 | 0.644 | 1143.495 | 0.101 | 0.090 | 0.191 | 0.228 | 0.306 | 0.067  |
| 6125  | 0   | 6106  | 0    | 19  | 0   | GET    | /api/app/[\w/-]+              | 0.002 | 2.336 | 1106.873 | 0.181 | 0.156 | 0.310 | 0.368 | 0.580 | 0.153  |
| 5134  | 0   | 5134  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.545 | 770.809  | 0.150 | 0.140 | 0.240 | 0.275 | 0.359 | 0.068  |
| 300   | 0   | 300   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.002 | 0.469 | 38.742   | 0.129 | 0.073 | 0.309 | 0.354 | 0.431 | 0.113  |
| 255   | 0   | 255   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.714 | 29.521   | 0.116 | 0.068 | 0.274 | 0.341 | 0.666 | 0.123  |
| 151   | 0   | 151   | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.568 | 12.196   | 0.081 | 0.004 | 0.281 | 0.406 | 0.557 | 0.134  |
| 1     | 0   | 1     | 0    | 0   | 0   | POST   | /api/initialize               | 7.752 | 7.752 | 7.752    | 7.752 | 7.752 | 7.752 | 7.752 | 7.752 | 0.000  |
| 5556  | 0   | 1262  | 4294 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.013 | 0.123    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 5     | 0   | 5     | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.008 | 0.034    | 0.007 | 0.007 | 0.008 | 0.008 | 0.008 | 0.001  |
| 1415  | 0   | 452   | 963  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.001 | 0.002    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 171   | 0   | 6     | 165  | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 655   | 0   | 111   | 544  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 157   | 0   | 50    | 107  | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+

# Profile
# Rank Query ID                      Response time  Calls R/Call V/M   Ite
# ==== ============================= ============== ===== ====== ===== ===
#    1 0x25D034CF58223D3C04329256... 204.1270 53.1%    92 2.2188  0.09 SELECT chairs chair_locations
#    2 0xD8DAD8AC6EDE2238F17AC39B...  45.7070 11.9% 11159 0.0041  0.00 SELECT rides
#    3 0x49D4717E21912CD8B13961B8...  40.5069 10.5% 11230 0.0036  0.00 SELECT chairs
#    4 0xFFFCA4D67EA0A788813031B8...  30.0237  7.8% 10760 0.0028  0.01 COMMIT

â†“

# Profile
# Rank Query ID                     Response time Calls  R/Call V/M   Item
# ==== ============================ ============= ====== ====== ===== ====
#    1 0xFFFCA4D67EA0A788813031B... 60.5358 22.2%  18859 0.0032  0.02 COMMIT
#    2 0xD8DAD8AC6EDE2238F17AC39... 53.7325 19.7%  16265 0.0033  0.00 SELECT rides
#    3 0x49D4717E21912CD8B13961B... 46.5710 17.1%  16389 0.0028  0.00 SELECT chairs


æ”¹å–„å‰:
å¹³å‡å¿œç­”æ™‚é–“: 3.002ç§’
P95: 3.989ç§’
å‘¼ã³å‡ºã—å›æ•°: 83å›
æ”¹å–„å¾Œ:
å¹³å‡å¿œç­”æ™‚é–“: 0.129ç§’ (96%æ”¹å–„ï¼)
P95: 0.354ç§’ (91%æ”¹å–„ï¼)
å‘¼ã³å‡ºã—å›æ•°: 300å›
ç‰¹ã«æ³¨ç›®ã™ã¹ãç‚¹ï¼š
ğŸš€ å¿œç­”æ™‚é–“ã®åŠ‡çš„ãªæ”¹å–„
3ç§’ â†’ 0.129ç§’ï¼ˆç´„23å€ã®é«˜é€ŸåŒ–ï¼‰
P95ã‚‚3.989ç§’ â†’ 0.354ç§’ï¼ˆç´„11å€ã®é«˜é€ŸåŒ–ï¼‰
ğŸ“ˆ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š
å‘¼ã³å‡ºã—å›æ•°ãŒ83å›â†’300å›ã«å¢—åŠ 
ã‚ˆã‚Šå¤šãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†å¯èƒ½ã«
ğŸ” ã‚¯ã‚¨ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å¤‰åŒ–
ä»¥å‰ã¯å…¨ä½“ã®31.4%ã‚’å ã‚ã¦ã„ãŸé‡ã„ã‚¯ã‚¨ãƒªãŒ
æ–°ã—ã„ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªãƒ­ã‚°ã«ã¯ä¸Šä½ã«ç¾ã‚Œãªããªã£ãŸ
æ¨å¥¨ã•ã‚Œã‚‹ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼š


## 11:52

```log
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| 11304 | 0   | 11292 | 0    | 12  | 0   | GET    | /api/chair/[\w/-]+            | 0.002 | 0.430 | 950.484 | 0.084 | 0.071 | 0.151 | 0.181 | 0.253 | 0.050  |
| 4296  | 0   | 4284  | 0    | 12  | 0   | GET    | /api/app/[\w/-]+              | 0.026 | 1.721 | 633.251 | 0.147 | 0.127 | 0.239 | 0.292 | 0.475 | 0.112  |
| 3772  | 0   | 3772  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.454 | 444.183 | 0.118 | 0.109 | 0.185 | 0.217 | 0.290 | 0.053  |
| 115   | 0   | 115   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.047 | 3.267 | 224.977 | 1.956 | 2.439 | 2.979 | 3.060 | 3.181 | 1.093  |
| 143   | 0   | 143   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.524 | 14.586  | 0.102 | 0.080 | 0.223 | 0.255 | 0.440 | 0.090  |
| 155   | 0   | 155   | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.221 | 4.695   | 0.030 | 0.019 | 0.069 | 0.136 | 0.201 | 0.040  |
| 1     | 0   | 1     | 0    | 0   | 0   | POST   | /api/initialize               | 2.480 | 2.480 | 2.480   | 2.480 | 2.480 | 2.480 | 2.480 | 2.480 | 0.000  |
| 2929  | 0   | 687   | 2242 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.011 | 0.064   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 5     | 0   | 5     | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.035   | 0.007 | 0.007 | 0.009 | 0.009 | 0.009 | 0.001  |
| 731   | 0   | 227   | 504  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.009 | 0.010   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 92    | 0   | 6     | 86   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 345   | 0   | 61    | 284  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 81    | 0   | 25    | 56   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
```

## 11:34

```log
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX | 2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM    |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| 8533  | 0   | 8516 | 0    | 17  | 0   | GET    | /api/chair/[\w/-]+            | 0.004 | 0.717 | 1017.350 | 0.119 | 0.088 | 0.251 | 0.296 | 0.368 | 0.086  |
| 1744  | 0   | 1738 | 0    | 6   | 0   | GET    | /api/app/[\w/-]+              | 0.001 | 4.333 | 587.885  | 0.337 | 0.312 | 0.462 | 0.505 | 0.890 | 0.368  |
| 2082  | 0   | 2082 | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.510 | 426.780  | 0.205 | 0.199 | 0.293 | 0.322 | 0.397 | 0.068  |
| 83    | 0   | 83   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.132 | 4.379 | 249.141  | 3.002 | 3.420 | 3.854 | 3.989 | 4.379 | 1.194  |
| 53    | 0   | 53   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.473 | 5.151    | 0.097 | 0.074 | 0.212 | 0.437 | 0.473 | 0.113  |
| 554   | 0   | 554  | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.497 | 3.745    | 0.007 | 0.001 | 0.003 | 0.017 | 0.211 | 0.035  |
| 1     | 0   | 1    | 0    | 0   | 0   | POST   | /api/initialize               | 1.926 | 1.926 | 1.926    | 1.926 | 1.926 | 1.926 | 1.926 | 1.926 | 0.000  |
| 5     | 0   | 5    | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.034    | 0.007 | 0.006 | 0.009 | 0.009 | 0.009 | 0.001  |
| 1706  | 0   | 365  | 1341 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.001 | 0.008    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 263   | 0   | 101  | 162  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.001 | 0.001    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 75    | 0   | 6    | 69   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 207   | 0   | 33   | 174  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 29    | 0   | 11   | 18   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
```

## 11:45 ğŸ” ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ

### ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‹ã‚‰ã®è¦³å¯Ÿ
- `/api/chair/[w/-]+` ã¸ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæœ€ã‚‚å¤šã„ (8,533ä»¶)
  - å¹³å‡å¿œç­”æ™‚é–“: 119ms
  - 95ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«: 296ms
- `/api/app/[w/-]+` ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚‚é‡ã„
  - å¹³å‡å¿œç­”æ™‚é–“: 337ms
  - æœ€å¤§: 4.333s
- `/api/owner/[w/-]+` ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç‰¹ã«é…ã„
  - å¹³å‡å¿œç­”æ™‚é–“: 3.002s
  - æœ€å¤§: 4.379s

### slow queryãƒ­ã‚°ã‹ã‚‰ã®ä¸»ãªå•é¡Œç‚¹

1. **æ¤…å­ã®ç·ç§»å‹•è·é›¢è¨ˆç®—ãŒé‡ã„ (å®Ÿè¡Œæ™‚é–“ã®31.4%)**
   - 3-4ç§’ã‹ã‹ã‚‹ã‚±ãƒ¼ã‚¹ã‚ã‚Š
   - chair_locationsãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®é›†è¨ˆãŒéåŠ¹ç‡

2. **ride_statusesãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®é »ç¹ãªã‚¢ã‚¯ã‚»ã‚¹ (åˆè¨ˆ49%)**
   - 4.4kè¡Œã®ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ãŒç™ºç”Ÿ
   - ç‰¹ã«æœ€æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ãŒé…ã„

3. **chair_locationsã®ä½ç½®æƒ…å ±å–å¾—ãŒé…ã„**
   - 20kä»¥ä¸Šã®è¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³
   - æœ€æ–°ä½ç½®ã®å–å¾—ã«170msç¨‹åº¦

### ğŸ’¡ æ”¹å–„æ¡ˆ

1. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ **

```sql
-- ride_statusesã®æ¤œç´¢æ”¹å–„
ALTER TABLE ride_statuses ADD INDEX idx_ride_status_lookup (ride_id, created_at);
ALTER TABLE ride_statuses ADD INDEX idx_ride_chair_status (ride_id, chair_sent_at, created_at);

-- chair_locationsæ¤œç´¢ã®æ”¹å–„
ALTER TABLE chair_locations ADD INDEX idx_chair_latest (chair_id, created_at);
```

2. **é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å°å…¥**

```sql
CREATE TABLE chair_distance_summary (
    chair_id VARCHAR(26) PRIMARY KEY,
    total_distance DECIMAL(10,2),
    last_updated DATETIME(6),
    INDEX idx_chair_distance (chair_id)
);
```

3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**
- Redis/Memcachedã®å°å…¥
- ç‰¹ã«é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  - ride_statusesã®æœ€æ–°çŠ¶æ…‹
  - chairã®ç¾åœ¨ä½ç½®æƒ…å ±
  - ownerã®èªè¨¼æƒ…å ±

### ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ
- `/api/chair/[w/-]+` GET: 119ms â†’ 30ms
- `/api/app/[w/-]+` GET: 337ms â†’ 50ms
- `/api/owner/[w/-]+` GET: 3.002s â†’ 200msä»¥ä¸‹

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ã«ã‚ˆã‚‹å³åŠ¹æ€§ã®é«˜ã„æ”¹å–„
2. é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã¨ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã®å®Ÿè£…

