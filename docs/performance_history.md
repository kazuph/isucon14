# ISUCON 14 2024-12-08のパフォーマンス改善履歴
## 11:52

```log
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| 11304 | 0   | 11292 | 0    | 12  | 0   | GET    | /api/chair/[\w/-]+            | 0.002 | 0.430 | 950.484 | 0.084 | 0.071 | 0.151 | 0.181 | 0.253 | 0.050  |
| 4296  | 0   | 4284  | 0    | 12  | 0   | GET    | /api/app/[\w/-]+              | 0.026 | 1.721 | 633.251 | 0.147 | 0.127 | 0.239 | 0.292 | 0.475 | 0.112  |
| 3772  | 0   | 3772  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.454 | 444.183 | 0.118 | 0.109 | 0.185 | 0.217 | 0.290 | 0.053  |
| 115   | 0   | 115   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.047 | 3.267 | 224.977 | 1.956 | 2.439 | 2.979 | 3.060 | 3.181 | 1.093  |
| 143   | 0   | 143   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.524 | 14.586  | 0.102 | 0.080 | 0.223 | 0.255 | 0.440 | 0.090  |
| 155   | 0   | 155   | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.221 | 4.695   | 0.030 | 0.019 | 0.069 | 0.136 | 0.201 | 0.040  |
| 1     | 0   | 1     | 0    | 0   | 0   | POST   | /api/initialize               | 2.480 | 2.480 | 2.480   | 2.480 | 2.480 | 2.480 | 2.480 | 2.480 | 0.000  |
| 2929  | 0   | 687   | 2242 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.011 | 0.064   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 5     | 0   | 5     | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.035   | 0.007 | 0.007 | 0.009 | 0.009 | 0.009 | 0.001  |
| 731   | 0   | 227   | 504  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.009 | 0.010   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 92    | 0   | 6     | 86   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 345   | 0   | 61    | 284  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 81    | 0   | 25    | 56   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
```

## 11:34

```log
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX | 2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM    |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| 8533  | 0   | 8516 | 0    | 17  | 0   | GET    | /api/chair/[\w/-]+            | 0.004 | 0.717 | 1017.350 | 0.119 | 0.088 | 0.251 | 0.296 | 0.368 | 0.086  |
| 1744  | 0   | 1738 | 0    | 6   | 0   | GET    | /api/app/[\w/-]+              | 0.001 | 4.333 | 587.885  | 0.337 | 0.312 | 0.462 | 0.505 | 0.890 | 0.368  |
| 2082  | 0   | 2082 | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.510 | 426.780  | 0.205 | 0.199 | 0.293 | 0.322 | 0.397 | 0.068  |
| 83    | 0   | 83   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.132 | 4.379 | 249.141  | 3.002 | 3.420 | 3.854 | 3.989 | 4.379 | 1.194  |
| 53    | 0   | 53   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.473 | 5.151    | 0.097 | 0.074 | 0.212 | 0.437 | 0.473 | 0.113  |
| 554   | 0   | 554  | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.497 | 3.745    | 0.007 | 0.001 | 0.003 | 0.017 | 0.211 | 0.035  |
| 1     | 0   | 1    | 0    | 0   | 0   | POST   | /api/initialize               | 1.926 | 1.926 | 1.926    | 1.926 | 1.926 | 1.926 | 1.926 | 1.926 | 0.000  |
| 5     | 0   | 5    | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.034    | 0.007 | 0.006 | 0.009 | 0.009 | 0.009 | 0.001  |
| 1706  | 0   | 365  | 1341 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.001 | 0.008    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 263   | 0   | 101  | 162  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.001 | 0.001    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 75    | 0   | 6    | 69   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 207   | 0   | 33   | 174  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 29    | 0   | 11   | 18   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
```

## 11:45 🔍 パフォーマンス分析

### アクセスログからの観察
- `/api/chair/[w/-]+` へのGETリクエストが最も多い (8,533件)
  - 平均応答時間: 119ms
  - 95パーセンタイル: 296ms
- `/api/app/[w/-]+` のGETリクエストも重い
  - 平均応答時間: 337ms
  - 最大: 4.333s
- `/api/owner/[w/-]+` のGETリクエストが特に遅い
  - 平均応答時間: 3.002s
  - 最大: 4.379s

### slow queryログからの主な問題点

1. **椅子の総移動距離計算が重い (実行時間の31.4%)**
   - 3-4秒かかるケースあり
   - chair_locationsテーブルでの集計が非効率

2. **ride_statusesテーブルへの頻繁なアクセス (合計49%)**
   - 4.4k行のフルスキャンが発生
   - 特に最新ステータス取得が遅い

3. **chair_locationsの位置情報取得が遅い**
   - 20k以上の行をスキャン
   - 最新位置の取得に170ms程度

### 💡 改善案

1. **インデックス追加**

```sql
-- ride_statusesの検索改善
ALTER TABLE ride_statuses ADD INDEX idx_ride_status_lookup (ride_id, created_at);
ALTER TABLE ride_statuses ADD INDEX idx_ride_chair_status (ride_id, chair_sent_at, created_at);

-- chair_locations検索の改善
ALTER TABLE chair_locations ADD INDEX idx_chair_latest (chair_id, created_at);
```

2. **集計テーブルの導入**

```sql
CREATE TABLE chair_distance_summary (
    chair_id VARCHAR(26) PRIMARY KEY,
    total_distance DECIMAL(10,2),
    last_updated DATETIME(6),
    INDEX idx_chair_distance (chair_id)
);
```

3. **キャッシュ戦略**
- Redis/Memcachedの導入
- 特に頻繁にアクセスされる以下の情報をキャッシュ
  - ride_statusesの最新状態
  - chairの現在位置情報
  - ownerの認証情報

### 🎯 期待される改善効果
- `/api/chair/[w/-]+` GET: 119ms → 30ms
- `/api/app/[w/-]+` GET: 337ms → 50ms
- `/api/owner/[w/-]+` GET: 3.002s → 200ms以下

次のステップ：
1. インデックス追加による即効性の高い改善
2. 集計テーブルの作成とデータ移行
3. キャッシュ層の実装

