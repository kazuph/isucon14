# ISUCON 14 2024-12-08ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„å±¥æ­´
## 11:52

```log
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| 11304 | 0   | 11292 | 0    | 12  | 0   | GET    | /api/chair/[\w/-]+            | 0.002 | 0.430 | 950.484 | 0.084 | 0.071 | 0.151 | 0.181 | 0.253 | 0.050  |
| 4296  | 0   | 4284  | 0    | 12  | 0   | GET    | /api/app/[\w/-]+              | 0.026 | 1.721 | 633.251 | 0.147 | 0.127 | 0.239 | 0.292 | 0.475 | 0.112  |
| 3772  | 0   | 3772  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.454 | 444.183 | 0.118 | 0.109 | 0.185 | 0.217 | 0.290 | 0.053  |
| 115   | 0   | 115   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.047 | 3.267 | 224.977 | 1.956 | 2.439 | 2.979 | 3.060 | 3.181 | 1.093  |
| 143   | 0   | 143   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.524 | 14.586  | 0.102 | 0.080 | 0.223 | 0.255 | 0.440 | 0.090  |
| 155   | 0   | 155   | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.221 | 4.695   | 0.030 | 0.019 | 0.069 | 0.136 | 0.201 | 0.040  |
| 1     | 0   | 1     | 0    | 0   | 0   | POST   | /api/initialize               | 2.480 | 2.480 | 2.480   | 2.480 | 2.480 | 2.480 | 2.480 | 2.480 | 0.000  |
| 2929  | 0   | 687   | 2242 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.011 | 0.064   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 5     | 0   | 5     | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.035   | 0.007 | 0.007 | 0.009 | 0.009 | 0.009 | 0.001  |
| 731   | 0   | 227   | 504  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.009 | 0.010   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 92    | 0   | 6     | 86   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 345   | 0   | 61    | 284  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 81    | 0   | 25    | 56   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
```

## 11:34

```log
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX | 2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM    |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| 8533  | 0   | 8516 | 0    | 17  | 0   | GET    | /api/chair/[\w/-]+            | 0.004 | 0.717 | 1017.350 | 0.119 | 0.088 | 0.251 | 0.296 | 0.368 | 0.086  |
| 1744  | 0   | 1738 | 0    | 6   | 0   | GET    | /api/app/[\w/-]+              | 0.001 | 4.333 | 587.885  | 0.337 | 0.312 | 0.462 | 0.505 | 0.890 | 0.368  |
| 2082  | 0   | 2082 | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.510 | 426.780  | 0.205 | 0.199 | 0.293 | 0.322 | 0.397 | 0.068  |
| 83    | 0   | 83   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.132 | 4.379 | 249.141  | 3.002 | 3.420 | 3.854 | 3.989 | 4.379 | 1.194  |
| 53    | 0   | 53   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.473 | 5.151    | 0.097 | 0.074 | 0.212 | 0.437 | 0.473 | 0.113  |
| 554   | 0   | 554  | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.497 | 3.745    | 0.007 | 0.001 | 0.003 | 0.017 | 0.211 | 0.035  |
| 1     | 0   | 1    | 0    | 0   | 0   | POST   | /api/initialize               | 1.926 | 1.926 | 1.926    | 1.926 | 1.926 | 1.926 | 1.926 | 1.926 | 0.000  |
| 5     | 0   | 5    | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.034    | 0.007 | 0.006 | 0.009 | 0.009 | 0.009 | 0.001  |
| 1706  | 0   | 365  | 1341 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.001 | 0.008    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 263   | 0   | 101  | 162  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.001 | 0.001    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 75    | 0   | 6    | 69   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 207   | 0   | 33   | 174  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 29    | 0   | 11   | 18   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
```

## 11:45 ğŸ” ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ

### ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‹ã‚‰ã®è¦³å¯Ÿ
- `/api/chair/[w/-]+` ã¸ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæœ€ã‚‚å¤šã„ (8,533ä»¶)
  - å¹³å‡å¿œç­”æ™‚é–“: 119ms
  - 95ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«: 296ms
- `/api/app/[w/-]+` ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚‚é‡ã„
  - å¹³å‡å¿œç­”æ™‚é–“: 337ms
  - æœ€å¤§: 4.333s
- `/api/owner/[w/-]+` ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç‰¹ã«é…ã„
  - å¹³å‡å¿œç­”æ™‚é–“: 3.002s
  - æœ€å¤§: 4.379s

### slow queryãƒ­ã‚°ã‹ã‚‰ã®ä¸»ãªå•é¡Œç‚¹

1. **æ¤…å­ã®ç·ç§»å‹•è·é›¢è¨ˆç®—ãŒé‡ã„ (å®Ÿè¡Œæ™‚é–“ã®31.4%)**
   - 3-4ç§’ã‹ã‹ã‚‹ã‚±ãƒ¼ã‚¹ã‚ã‚Š
   - chair_locationsãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®é›†è¨ˆãŒéåŠ¹ç‡

2. **ride_statusesãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®é »ç¹ãªã‚¢ã‚¯ã‚»ã‚¹ (åˆè¨ˆ49%)**
   - 4.4kè¡Œã®ãƒ•ãƒ«ã‚¹ã‚­ãƒ£ãƒ³ãŒç™ºç”Ÿ
   - ç‰¹ã«æœ€æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ãŒé…ã„

3. **chair_locationsã®ä½ç½®æƒ…å ±å–å¾—ãŒé…ã„**
   - 20kä»¥ä¸Šã®è¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³
   - æœ€æ–°ä½ç½®ã®å–å¾—ã«170msç¨‹åº¦

### ğŸ’¡ æ”¹å–„æ¡ˆ

1. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ **

```sql
-- ride_statusesã®æ¤œç´¢æ”¹å–„
ALTER TABLE ride_statuses ADD INDEX idx_ride_status_lookup (ride_id, created_at);
ALTER TABLE ride_statuses ADD INDEX idx_ride_chair_status (ride_id, chair_sent_at, created_at);

-- chair_locationsæ¤œç´¢ã®æ”¹å–„
ALTER TABLE chair_locations ADD INDEX idx_chair_latest (chair_id, created_at);
```

2. **é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å°å…¥**

```sql
CREATE TABLE chair_distance_summary (
    chair_id VARCHAR(26) PRIMARY KEY,
    total_distance DECIMAL(10,2),
    last_updated DATETIME(6),
    INDEX idx_chair_distance (chair_id)
);
```

3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**
- Redis/Memcachedã®å°å…¥
- ç‰¹ã«é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹ä»¥ä¸‹ã®æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  - ride_statusesã®æœ€æ–°çŠ¶æ…‹
  - chairã®ç¾åœ¨ä½ç½®æƒ…å ±
  - ownerã®èªè¨¼æƒ…å ±

### ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„åŠ¹æœ
- `/api/chair/[w/-]+` GET: 119ms â†’ 30ms
- `/api/app/[w/-]+` GET: 337ms â†’ 50ms
- `/api/owner/[w/-]+` GET: 3.002s â†’ 200msä»¥ä¸‹

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š
1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ã«ã‚ˆã‚‹å³åŠ¹æ€§ã®é«˜ã„æ”¹å–„
2. é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã¨ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
3. ã‚­ãƒ£ãƒƒã‚·ãƒ¥å±¤ã®å®Ÿè£…

