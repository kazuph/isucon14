# ISUCON 14 2024-12-08のパフォーマンス改善履歴



## 15:27 📊 インデックス効果の検証

> time=15:21:35.771 level=INFO msg=0.0%のライドは椅子がマッチされるまでの時間、100.0%のライドはマッチされた椅子が乗車地点までに掛かる時間、100.0%のライドは椅子の実移動時間に不満がありました

という評判が多く、前回の改善よりもスコアが下がってしまった。アプリケーションの構造をみて、スコアに寄与する改善を増やさないとだめ。

before

+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM    |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| 16242 | 0   | 16228 | 0    | 14  | 0   | GET    | /api/chair/[\w/-]+            | 0.001 | 0.372 | 1135.720 | 0.070 | 0.063 | 0.136 | 0.162 | 0.223 | 0.050  |
| 8845  | 0   | 8830  | 0    | 15  | 0   | GET    | /api/app/[\w/-]+              | 0.001 | 1.851 | 1126.848 | 0.127 | 0.109 | 0.224 | 0.271 | 0.420 | 0.117  |
| 7854  | 0   | 7854  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.393 | 831.235  | 0.106 | 0.099 | 0.168 | 0.198 | 0.264 | 0.049  |
| 298   | 0   | 298   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.003 | 0.537 | 30.659   | 0.103 | 0.061 | 0.244 | 0.292 | 0.439 | 0.097  |
| 304   | 0   | 304   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.467 | 26.202   | 0.086 | 0.058 | 0.199 | 0.240 | 0.323 | 0.077  |
| 183   | 0   | 182   | 0    | 0   | 1   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.526 | 8.083    | 0.044 | 0.003 | 0.145 | 0.191 | 0.401 | 0.079  |
| 1     | 0   | 1     | 0    | 0   | 0   | POST   | /api/initialize               | 7.847 | 7.847 | 7.847    | 7.847 | 7.847 | 7.847 | 7.847 | 7.847 | 0.000  |
| 6149  | 0   | 1515  | 4634 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.012 | 0.150    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 5     | 0   | 5     | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.007 | 0.033    | 0.007 | 0.007 | 0.007 | 0.007 | 0.007 | 0.000  |
| 1694  | 0   | 551   | 1143 | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.002 | 0.004    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 717   | 0   | 133   | 584  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 171   | 0   | 6     | 165  | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 188   | 0   | 61    | 127  | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+

after

+-------+-----+-------+------+-----+-----+--------+-------------------------------+--------+--------+----------+--------+--------+--------+--------+--------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN   |  MAX   |   SUM    |  AVG   |  P50   |  P90   |  P95   |  P99   | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+--------+--------+----------+--------+--------+--------+--------+--------+--------+
| 7597  | 0   | 7577  | 0    | 20  | 0   | GET    | /api/app/[\w/-]+              | 0.001  | 2.515  | 1215.376 | 0.160  | 0.120  | 0.302  | 0.362  | 0.692  | 0.166  |
| 12903 | 0   | 12886 | 0    | 17  | 0   | GET    | /api/chair/[\w/-]+            | 0.001  | 0.501  | 1062.944 | 0.082  | 0.065  | 0.175  | 0.219  | 0.306  | 0.067  |
| 6754  | 0   | 6754  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006  | 0.577  | 869.196  | 0.129  | 0.111  | 0.227  | 0.265  | 0.356  | 0.071  |
| 293   | 0   | 293   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.003  | 0.710  | 36.544   | 0.125  | 0.071  | 0.289  | 0.410  | 0.569  | 0.127  |
| 233   | 0   | 233   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001  | 1.370  | 26.215   | 0.113  | 0.078  | 0.272  | 0.330  | 0.446  | 0.128  |
| 187   | 0   | 187   | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001  | 0.695  | 12.069   | 0.065  | 0.024  | 0.170  | 0.310  | 0.616  | 0.113  |
| 1     | 0   | 1     | 0    | 0   | 0   | POST   | /api/initialize               | 11.284 | 11.284 | 11.284   | 11.284 | 11.284 | 11.284 | 11.284 | 11.284 | 0.000  |
| 5810  | 0   | 1193  | 4617 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000  | 0.008  | 0.089    | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  |
| 5     | 0   | 5     | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006  | 0.007  | 0.032    | 0.006  | 0.006  | 0.007  | 0.007  | 0.007  | 0.000  |
| 1559  | 0   | 425   | 1134 | 0   | 0   | GET    | /images/[\w.-]+               | 0.000  | 0.002  | 0.002    | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  |
| 171   | 0   | 6     | 165  | 0   | 0   | GET    | /owner                        | 0.000  | 0.000  | 0.000    | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /index.html                   | 0.000  | 0.000  | 0.000    | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000  | 0.000  | 0.000    | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  |
| 687   | 0   | 105   | 582  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000  | 0.000  | 0.000    | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  |
| 173   | 0   | 47    | 126  | 0   | 0   | GET    | /client                       | 0.000  | 0.000  | 0.000    | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+--------+--------+----------+--------+--------+--------+--------+--------+--------+


### 実施した改善の効果
- Rows examineの劇的な改善
  - 33.65M → 507.81k（約98.5%削減！）
  - クエリの効率が大幅に向上

### クエリごとの改善
1. **SELECT rides**
   - 実行時間: 21.76s → 2.23s（約90%改善）
   - インデックスが効果的に機能

2. **SELECT chairs**
   - Rows examine: 複数行 → 1行
   - インデックスによる直接アクセスの実現

### 新たな課題
1. **COMMITの比重増加**
   - 全体の44%を占める（前回38.2%）
   - トランザクション最適化の必要性

2. **chair_locationsの重いINSERT**
   - 最大4.4秒のINSERTが発生
   - トリガー処理の見直しが必要

### 次のステップ
1. トランザクションの最適化
2. トリガー処理の軽量化
3. couponsテーブルのインデックス追加を検討

## 15:14 🎯 rides テーブルのユーザー検索最適化

### 実施した改善
1. `rides`テーブルに複合インデックス追加
   - `idx_user_created (user_id, created_at DESC)`
   - ユーザーごとのライド履歴検索を最適化

### 改善のきっかけ
- スロークエリログで`rides`テーブルのユーザー検索が遅い
  - `SELECT * FROM rides WHERE user_id = ? ORDER BY created_at DESC LIMIT 1`
  - 790行/クエリを検査
  - 7,723回実行

### 改善効果
- `SELECT rides`の実行時間: 21.76s → 2.60s（約88%改善！）
- APIエンドポイントの改善:
  - `GET /api/app/[\w/-]+`
    - P95: 0.326s → 0.271s
    - 平均: 0.145s → 0.127s
- Rows examineが大幅に減少: 33.65M → 5.19M

## 14:52 🚀 インデックス最適化の効果

### 実施した改善
1. `rides`テーブルに複合インデックス追加
   - `idx_chair_updated (chair_id, updated_at DESC)`
2. `chairs`テーブルにインデックス追加
   - `idx_access_token (access_token)`

### 改善効果
- Rows examineが大幅に減少: 33.65M → 10.68M (約68%減少)
- 実行時間の改善: 273s → 208s (約24%減少)
- クエリプロファイルの変化:
  - `SELECT chairs`のレスポンスタイム: 46.57s → 7.36s (約84%改善)
  - `SELECT rides`のレスポンスタイム: 53.73s → 6.59s (約88%改善)

### APIエンドポイントの改善
- `/api/chair/[w/-]+` GET
  - P95: 0.228s → 0.180s (約21%改善)
  - 平均: 0.101s → 0.072s (約29%改善)
- `/api/app/[w/-]+` GET
  - P95: 0.368s → 0.326s (約11%改善)
  - 平均: 0.181s → 0.145s (約20%改善)

### 次のステップ
1. トランザクションの最適化 (COMMITが依然として遅い)
2. キャッシュ戦略の検討
3. 残りのスロークエリの分析と改善


## 14:36

+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM    |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| 11287 | 0   | 11272 | 0    | 15  | 0   | GET    | /api/chair/[\w/-]+            | 0.005 | 0.644 | 1143.495 | 0.101 | 0.090 | 0.191 | 0.228 | 0.306 | 0.067  |
| 6125  | 0   | 6106  | 0    | 19  | 0   | GET    | /api/app/[\w/-]+              | 0.002 | 2.336 | 1106.873 | 0.181 | 0.156 | 0.310 | 0.368 | 0.580 | 0.153  |
| 5134  | 0   | 5134  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.545 | 770.809  | 0.150 | 0.140 | 0.240 | 0.275 | 0.359 | 0.068  |
| 300   | 0   | 300   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.002 | 0.469 | 38.742   | 0.129 | 0.073 | 0.309 | 0.354 | 0.431 | 0.113  |
| 255   | 0   | 255   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.714 | 29.521   | 0.116 | 0.068 | 0.274 | 0.341 | 0.666 | 0.123  |
| 151   | 0   | 151   | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.568 | 12.196   | 0.081 | 0.004 | 0.281 | 0.406 | 0.557 | 0.134  |
| 1     | 0   | 1     | 0    | 0   | 0   | POST   | /api/initialize               | 7.752 | 7.752 | 7.752    | 7.752 | 7.752 | 7.752 | 7.752 | 7.752 | 0.000  |
| 5556  | 0   | 1262  | 4294 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.013 | 0.123    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 5     | 0   | 5     | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.008 | 0.034    | 0.007 | 0.007 | 0.008 | 0.008 | 0.008 | 0.001  |
| 1415  | 0   | 452   | 963  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.001 | 0.002    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 171   | 0   | 6     | 165  | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1     | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 655   | 0   | 111   | 544  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 157   | 0   | 50    | 107  | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+

# Profile
# Rank Query ID                      Response time  Calls R/Call V/M   Ite
# ==== ============================= ============== ===== ====== ===== ===
#    1 0x25D034CF58223D3C04329256... 204.1270 53.1%    92 2.2188  0.09 SELECT chairs chair_locations
#    2 0xD8DAD8AC6EDE2238F17AC39B...  45.7070 11.9% 11159 0.0041  0.00 SELECT rides
#    3 0x49D4717E21912CD8B13961B8...  40.5069 10.5% 11230 0.0036  0.00 SELECT chairs
#    4 0xFFFCA4D67EA0A788813031B8...  30.0237  7.8% 10760 0.0028  0.01 COMMIT

↓

# Profile
# Rank Query ID                     Response time Calls  R/Call V/M   Item
# ==== ============================ ============= ====== ====== ===== ====
#    1 0xFFFCA4D67EA0A788813031B... 60.5358 22.2%  18859 0.0032  0.02 COMMIT
#    2 0xD8DAD8AC6EDE2238F17AC39... 53.7325 19.7%  16265 0.0033  0.00 SELECT rides
#    3 0x49D4717E21912CD8B13961B... 46.5710 17.1%  16389 0.0028  0.00 SELECT chairs


改善前:
平均応答時間: 3.002秒
P95: 3.989秒
呼び出し回数: 83回
改善後:
平均応答時間: 0.129秒 (96%改善！)
P95: 0.354秒 (91%改善！)
呼び出し回数: 300回
特に注目すべき点：
🚀 応答時間の劇的な改善
3秒 → 0.129秒（約23倍の高速化）
P95も3.989秒 → 0.354秒（約11倍の高速化）
📈 スケーラビリテの向上
呼び出し回数が83回→300回に増加
より多くのリクエストを処理可能に
🔍 クエリランキングの変化
以前は全体の31.4%を占めていた重いクエリが
新しいスロークエリログには上位に現れなくなった
推奨されるコミットメッセージ：


## 11:52

```log
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX |  2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM   |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
| 11304 | 0   | 11292 | 0    | 12  | 0   | GET    | /api/chair/[\w/-]+            | 0.002 | 0.430 | 950.484 | 0.084 | 0.071 | 0.151 | 0.181 | 0.253 | 0.050  |
| 4296  | 0   | 4284  | 0    | 12  | 0   | GET    | /api/app/[\w/-]+              | 0.026 | 1.721 | 633.251 | 0.147 | 0.127 | 0.239 | 0.292 | 0.475 | 0.112  |
| 3772  | 0   | 3772  | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.454 | 444.183 | 0.118 | 0.109 | 0.185 | 0.217 | 0.290 | 0.053  |
| 115   | 0   | 115   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.047 | 3.267 | 224.977 | 1.956 | 2.439 | 2.979 | 3.060 | 3.181 | 1.093  |
| 143   | 0   | 143   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.524 | 14.586  | 0.102 | 0.080 | 0.223 | 0.255 | 0.440 | 0.090  |
| 155   | 0   | 155   | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.221 | 4.695   | 0.030 | 0.019 | 0.069 | 0.136 | 0.201 | 0.040  |
| 1     | 0   | 1    | 0    | 0   | 0   | POST   | /api/initialize               | 2.480 | 2.480 | 2.480   | 2.480 | 2.480 | 2.480 | 2.480 | 2.480 | 0.000  |
| 2929  | 0   | 687   | 2242 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.011 | 0.064   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 5     | 0   | 5    | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.035   | 0.007 | 0.007 | 0.009 | 0.009 | 0.009 | 0.001  |
| 731   | 0   | 227   | 504  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.009 | 0.010   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 92    | 0   | 6    | 86   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 345   | 0   | 61    | 284  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 81    | 0   | 25    | 56   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000   | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+-------+------+-----+-----+--------+-------------------------------+-------+-------+---------+-------+-------+-------+-------+-------+--------+
```

## 11:34

```log
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| COUNT | 1XX | 2XX  | 3XX  | 4XX | 5XX | METHOD |              URI              |  MIN  |  MAX  |   SUM    |  AVG  |  P50  |  P90  |  P95  |  P99  | STDDEV |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
| 8533  | 0   | 8516 | 0    | 17  | 0   | GET    | /api/chair/[\w/-]+            | 0.004 | 0.717 | 1017.350 | 0.119 | 0.088 | 0.251 | 0.296 | 0.368 | 0.086  |
| 1744  | 0   | 1738 | 0    | 6   | 0   | GET    | /api/app/[\w/-]+              | 0.001 | 4.333 | 587.885  | 0.337 | 0.312 | 0.462 | 0.505 | 0.890 | 0.368  |
| 2082  | 0   | 2082 | 0    | 0   | 0   | POST   | /api/chair/[\w/-]+            | 0.006 | 0.510 | 426.780  | 0.205 | 0.199 | 0.293 | 0.322 | 0.397 | 0.068  |
| 83    | 0   | 83   | 0    | 0   | 0   | GET    | /api/owner/[\w/-]+            | 0.132 | 4.379 | 249.141  | 3.002 | 3.420 | 3.854 | 3.989 | 4.379 | 1.194  |
| 53    | 0   | 53   | 0    | 0   | 0   | POST   | /api/app/[\w/-]+              | 0.001 | 0.473 | 5.151    | 0.097 | 0.074 | 0.212 | 0.437 | 0.473 | 0.113  |
| 554   | 0   | 554  | 0    | 0   | 0   | GET    | /api/internal/[\w/-]+         | 0.001 | 0.497 | 3.745    | 0.007 | 0.001 | 0.003 | 0.017 | 0.211 | 0.035  |
| 1     | 0   | 1    | 0    | 0   | 0   | POST   | /api/initialize               | 1.926 | 1.926 | 1.926    | 1.926 | 1.926 | 1.926 | 1.926 | 1.926 | 0.000  |
| 5     | 0   | 5    | 0    | 0   | 0   | POST   | /api/owner/[\w/-]+            | 0.006 | 0.009 | 0.034    | 0.007 | 0.006 | 0.009 | 0.009 | 0.009 | 0.001  |
| 1706  | 0   | 365  | 1341 | 0   | 0   | GET    | /assets/[\w.-]+               | 0.000 | 0.001 | 0.008    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 263   | 0   | 101  | 162  | 0   | 0   | GET    | /images/[\w.-]+               | 0.000 | 0.001 | 0.001    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 75    | 0   | 6    | 69   | 0   | 0   | GET    | /owner                        | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /index.html                   | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 1     | 0   | 1    | 0    | 0   | 0   | GET    | /apple-touch-icon-180x180.png | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 207   | 0   | 33   | 174  | 0   | 0   | GET    | /favicon[\w.-]*               | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
| 29    | 0   | 11   | 18   | 0   | 0   | GET    | /client                       | 0.000 | 0.000 | 0.000    | 0.000 | 0.000 | 0.000 | 0.000 | 0.000 | 0.000  |
+-------+-----+------+------+-----+-----+--------+-------------------------------+-------+-------+----------+-------+-------+-------+-------+-------+--------+
```

## 11:45 🔍 パフォーマンス分析

### アクセスログからの観察
- `/api/chair/[w/-]+` へのGETリクエストが最も多い (8,533)
  - 平均応答時間: 119ms
  - 95パーセンタイル: 296ms
- `/api/app/[w/-]+` のGETリクエストも重い
  - 平均応答時間: 337ms
  - 最大: 4.333s
- `/api/owner/[w/-]+` のGETリクエストが特に遅い
  - 平均応答時間: 3.002s
  - 最大: 4.379s

### slow queryログか���の主な問題点

1. **椅子の総移動距離計算が重い (実行時間の31.4%)**
   - 3-4秒かかるケースあり
   - chair_locationsテーブルでの集計が非効率

2. **ride_statusesテーブルへの頻繁なアクセス (合計49%)**
   - 4.4k行のフルスキャンが発生
   - 特に新ステータス取得が遅い

3. **chair_locationsの位置情報取得が遅い**
   - 20k以上の行をスキャン
   - 最新位置の取得に170ms程度

### 💡 改善案

1. **インデックス追加**

```sql
-- ride_statusesの検索改善
ALTER TABLE ride_statuses ADD INDEX idx_ride_status_lookup (ride_id, created_at);
ALTER TABLE ride_statuses ADD INDEX idx_ride_chair_status (ride_id, chair_sent_at, created_at);

-- chair_locations検索の改善
ALTER TABLE chair_locations ADD INDEX idx_chair_latest (chair_id, created_at);
```

2. **集計テーブルの導入**

```sql
CREATE TABLE chair_distance_summary (
    chair_id VARCHAR(26) PRIMARY KEY,
    total_distance DECIMAL(10,2),
    last_updated DATETIME(6),
    INDEX idx_chair_distance (chair_id)
);
```

3. **キャッシュ戦略**
- Redis/Memcachedの導入
- 特に頻繁にアクセスされる以下の情報をキャッシュ
  - ride_statusesの最新状態
  - chairの現在位置情報
  - ownerの認証情報

### 🎯 期待��れる改善効果
- `/api/chair/[w/-]+` GET: 119ms → 30ms
- `/api/app/[w/-]+` GET: 337ms → 50ms
- `/api/owner/[w/-]+` GET: 3.002s → 200ms以下

次のステップ：
1. インデックス追加による即効性の高い改善
2. 集計テーブルの作成とデータ移行
3. キャッシュ層の実装

